{"ast":null,"code":"\"use strict\";\n\nvar __importDefault = this && this.__importDefault || function (mod) {\n  return mod && mod.__esModule ? mod : {\n    \"default\": mod\n  };\n};\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.Registry = void 0;\nconst dns_equal_1 = __importDefault(require(\"./utils/dns-equal\"));\nconst service_1 = __importDefault(require(\"./service\"));\nconst REANNOUNCE_MAX_MS = 60 * 60 * 1000;\nconst REANNOUNCE_FACTOR = 3;\nconst noop = function () {};\nclass Registry {\n  constructor(server) {\n    this.services = [];\n    this.server = server;\n  }\n  publish(config) {\n    function start(service, registry, opts) {\n      if (service.activated) return;\n      service.activated = true;\n      registry.services.push(service);\n      if (!(service instanceof service_1.default)) return;\n      if (opts === null || opts === void 0 ? void 0 : opts.probe) {\n        registry.probe(registry.server.mdns, service, exists => {\n          if (exists) {\n            if (service.stop !== undefined) service.stop();\n            console.log(new Error('Service name is already in use on the network'));\n            return;\n          }\n          registry.announce(registry.server, service);\n        });\n      } else {\n        registry.announce(registry.server, service);\n      }\n    }\n    function stop(service, registry, callback) {\n      if (!callback) callback = noop;\n      if (!service.activated) return process.nextTick(callback);\n      if (!(service instanceof service_1.default)) return process.nextTick(callback);\n      registry.teardown(registry.server, service, callback);\n      const index = registry.services.indexOf(service);\n      if (index !== -1) registry.services.splice(index, 1);\n    }\n    const service = new service_1.default(config);\n    service.start = start.bind(null, service, this);\n    service.stop = stop.bind(null, service, this);\n    service.start({\n      probe: config.probe !== false\n    });\n    return service;\n  }\n  unpublishAll(callback) {\n    this.teardown(this.server, this.services, callback);\n    this.services = [];\n  }\n  destroy() {\n    this.services.map(service => service.destroyed = true);\n  }\n  probe(mdns, service, callback) {\n    var sent = false;\n    var retries = 0;\n    var timer;\n    const send = () => {\n      if (!service.activated || service.destroyed) return;\n      mdns.query(service.fqdn, 'ANY', function () {\n        sent = true;\n        timer = setTimeout(++retries < 3 ? send : done, 250);\n        timer.unref();\n      });\n    };\n    const onresponse = packet => {\n      if (!sent) return;\n      if (packet.answers.some(matchRR) || packet.additionals.some(matchRR)) done(true);\n    };\n    const matchRR = rr => {\n      return (0, dns_equal_1.default)(rr.name, service.fqdn);\n    };\n    const done = exists => {\n      mdns.removeListener('response', onresponse);\n      clearTimeout(timer);\n      callback(!!exists);\n    };\n    mdns.on('response', onresponse);\n    setTimeout(send, Math.random() * 250);\n  }\n  announce(server, service) {\n    var delay = 1000;\n    var packet = service.records();\n    server.register(packet);\n    const broadcast = () => {\n      if (!service.activated || service.destroyed) return;\n      server.mdns.respond(packet, function () {\n        if (!service.published) {\n          service.activated = true;\n          service.published = true;\n          service.emit('up');\n        }\n        delay = delay * REANNOUNCE_FACTOR;\n        if (delay < REANNOUNCE_MAX_MS && !service.destroyed) {\n          setTimeout(broadcast, delay).unref();\n        }\n      });\n    };\n    broadcast();\n  }\n  teardown(server, services, callback) {\n    if (!Array.isArray(services)) services = [services];\n    services = services.filter(service => service.activated);\n    var records = services.flatMap(function (service) {\n      service.activated = false;\n      var records = service.records();\n      records.forEach(record => {\n        record.ttl = 0;\n      });\n      return records;\n    });\n    if (records.length === 0) return callback && process.nextTick(callback);\n    server.unregister(records);\n    server.mdns.respond(records, function () {\n      services.forEach(function (service) {\n        service.published = false;\n      });\n      if (typeof callback === \"function\") {\n        callback.apply(null, arguments);\n      }\n    });\n  }\n}\nexports.Registry = Registry;\nexports.default = Registry;","map":{"version":3,"names":["dns_equal_1","__importDefault","require","service_1","REANNOUNCE_MAX_MS","REANNOUNCE_FACTOR","noop","Registry","constructor","server","services","publish","config","start","service","registry","opts","activated","push","default","probe","mdns","exists","stop","undefined","console","log","Error","announce","callback","process","nextTick","teardown","index","indexOf","splice","bind","unpublishAll","destroy","map","destroyed","sent","retries","timer","send","query","fqdn","setTimeout","done","unref","onresponse","packet","answers","some","matchRR","additionals","rr","name","removeListener","clearTimeout","on","Math","random","delay","records","register","broadcast","respond","published","emit","Array","isArray","filter","flatMap","forEach","record","ttl","length","unregister","apply","arguments","exports"],"sources":["../../src/lib/registry.ts"],"sourcesContent":[null],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"script","externalDependencies":[]}